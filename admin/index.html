<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leome Admin Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .dashboard-container {
      display: none;
      padding: 20px;
    }
    .navbar-brand {
      font-weight: bold;
      color: #ec4899 !important;
    }
    .card {
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      border: none;
    }
    .card-header {
      background-color: #ec4899;
      color: white;
      font-weight: bold;
    }
    .character-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 15px;
      overflow: hidden;
    }
    .character-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
    }
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      display: none;
    }
    .active-badge {
      background-color: #28a745;
    }
    .inactive-badge {
      background-color: #dc3545;
    }
  </style>
</head>
<body>
  <!-- Loading Spinner -->
  <div class="spinner-overlay" id="spinner">
    <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Login Form -->
  <div class="login-container" id="loginContainer">
    <h2 class="text-center mb-4">Leome Admin</h2>
    <form id="loginForm">
      <div class="mb-3">
        <label for="username" class="form-label">Username</label>
        <input type="text" class="form-control" id="username" required>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password" required>
      </div>
      <button type="submit" class="btn btn-primary w-100" style="background-color: #ec4899; border: none;">Login</button>
    </form>
  </div>

  <!-- Dashboard -->
  <div class="dashboard-container" id="dashboardContainer">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Leome Admin</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link active" href="#" id="dashboardNav">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="charactersNav">Characters</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="reportsNav">Reports</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="newCharacterNav">Add Character</a>
            </li>
          </ul>
          <span class="navbar-text text-white me-3">
            <i class="fas fa-user me-1"></i> Admin
          </span>
          <button class="btn btn-outline-light btn-sm" id="logoutBtn">Logout</button>
        </div>
      </div>
    </nav>

    <!-- Main Content Container -->
    <div class="container">
      <!-- Dashboard Section -->
      <div id="dashboardSection">
        <h2 class="mb-4">Dashboard</h2>
        <div class="row">
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">Total Characters</div>
              <div class="card-body">
                <h5 class="card-title" id="totalCharacters">0</h5>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">Active Characters</div>
              <div class="card-body">
                <h5 class="card-title" id="activeCharacters">0</h5>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">Inactive Characters</div>
              <div class="card-body">
                <h5 class="card-title" id="inactiveCharacters">0</h5>
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <div class="card-header">Server Information</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <p><strong>Server Uptime:</strong> <span id="serverUptime">0</span> seconds</p>
                <p><strong>Node Version:</strong> <span id="nodeVersion">-</span></p>
              </div>
              <div class="col-md-6">
                <p><strong>MongoDB Connection:</strong> <span id="mongoConnection">-</span></p>
                <p><strong>Environment:</strong> <span id="environment">-</span></p>
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <div class="card-header">Recent Reports</div>
          <div class="card-body">
            <div id="dashboardRecentReports">
              <p class="text-center">Loading recent reports...</p>
            </div>
            <div class="text-center mt-3">
              <button id="viewAllReportsBtn" class="btn btn-primary" style="background-color: #ec4899; border: none;">
                View All Reports
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Characters Section -->
      <div id="charactersSection" style="display:none;">
        <h2 class="mb-4">Manage Characters</h2>
        <div class="card">
          <div class="card-header">
            <div class="row align-items-center">
              <div class="col">
                Characters List
              </div>
              <div class="col-auto">
                <input type="text" class="form-control form-control-sm" placeholder="Search..." id="characterSearch">
              </div>
            </div>
          </div>
          <div class="card-body">
            <div id="charactersList">
              <!-- Characters will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reportsSection" style="display:none;">
        <h2 class="mb-4">Content Reports</h2>
        
        <!-- Report Stats Cards -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card">
              <div class="card-header">Total Reports</div>
              <div class="card-body">
                <h5 class="card-title" id="totalReports">0</h5>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-header">Pending</div>
              <div class="card-body">
                <h5 class="card-title" id="pendingReports">0</h5>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-header">Resolved</div>
              <div class="card-body">
                <h5 class="card-title" id="resolvedReports">0</h5>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-header">Dismissed</div>
              <div class="card-body">
                <h5 class="card-title" id="dismissedReports">0</h5>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Report Filters -->
        <div class="card mb-4">
          <div class="card-header">Filters</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <label for="reportStatusFilter" class="form-label">Status</label>
                <select id="reportStatusFilter" class="form-select">
                  <option value="">All Statuses</option>
                  <option value="pending">Pending</option>
                  <option value="reviewing">Reviewing</option>
                  <option value="resolved">Resolved</option>
                  <option value="dismissed">Dismissed</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="reportCharacterFilter" class="form-label">Character</label>
                <select id="reportCharacterFilter" class="form-select">
                  <option value="">All Characters</option>
                  <!-- Will be populated dynamically -->
                </select>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button id="applyReportFilters" class="btn btn-primary w-100" style="background-color: #ec4899; border: none;">
                  Apply Filters
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Reports List -->
        <div class="card">
          <div class="card-header">Reports</div>
          <div class="card-body">
            <div id="reportsList">
              <!-- Reports will be populated here -->
            </div>
            <nav aria-label="Report pagination" class="mt-3">
              <ul class="pagination justify-content-center" id="reportPagination">
                <!-- Pagination will be populated here -->
              </ul>
            </nav>
          </div>
        </div>
      </div>

      <!-- Report Details Modal -->
      <div class="modal fade" id="reportDetailsModal" tabindex="-1" aria-labelledby="reportDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="reportDetailsModalLabel">Report Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row mb-4">
                <div class="col-md-6">
                  <p><strong>Report ID:</strong> <span id="modalReportId"></span></p>
                  <p><strong>Character:</strong> <span id="modalCharacterName"></span></p>
                  <p><strong>Status:</strong> <span id="modalReportStatus" class="badge bg-warning"></span></p>
                  <p><strong>Reason:</strong> <span id="modalReportReason"></span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Reported By:</strong> <span id="modalReporterId"></span></p>
                  <p><strong>Date:</strong> <span id="modalReportDate"></span></p>
                  <p><strong>App Version:</strong> <span id="modalAppVersion"></span></p>
                </div>
              </div>
              
              <div class="card mb-4">
                <div class="card-header">Reported Message</div>
                <div class="card-body bg-light">
                  <p id="modalMessageContent" class="mb-0"></p>
                </div>
              </div>
              
              <div class="card mb-4" id="additionalDetailsCard">
                <div class="card-header">Additional Details</div>
                <div class="card-body bg-light">
                  <p id="modalAdditionalDetails" class="mb-0"></p>
                </div>
              </div>
              
              <form id="reportUpdateForm">
                <div class="mb-3">
                  <label for="updateReportStatus" class="form-label">Update Status</label>
                  <select class="form-select" id="updateReportStatus">
                    <option value="pending">Pending</option>
                    <option value="reviewing">Reviewing</option>
                    <option value="resolved">Resolved</option>
                    <option value="dismissed">Dismissed</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="updateReportNotes" class="form-label">Admin Notes</label>
                  <textarea class="form-control" id="updateReportNotes" rows="3"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="saveReportChanges" style="background-color: #ec4899; border: none;">Save Changes</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add/Edit Character Section -->
      <div id="newCharacterSection" style="display:none;">
        <h2 class="mb-4" id="characterFormTitle">Add New Character</h2>
        <div class="card">
          <div class="card-header">Character Details</div>
          <div class="card-body">
            <form id="characterForm" enctype="multipart/form-data">
              <input type="hidden" id="characterId">
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="name" class="form-label">Name*</label>
                  <input type="text" class="form-control" id="name" required>
                </div>
                <div class="col-md-6">
                  <label for="age" class="form-label">Age</label>
                  <input type="text" class="form-control" id="age">
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="location" class="form-label">Location</label>
                  <input type="text" class="form-control" id="location">
                </div>
                <div class="col-md-6">
                  <label for="responseTime" class="form-label">Response Time</label>
                  <input type="text" class="form-control" id="responseTime" placeholder="< 1 min">
                </div>
              </div>
              
              <div class="mb-3">
                <label for="description" class="form-label">Description*</label>
                <textarea class="form-control" id="description" rows="3" required></textarea>
              </div>
              
              <div class="mb-3">
                <label for="personality" class="form-label">Personality*</label>
                <textarea class="form-control" id="personality" rows="2" required></textarea>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="traits" class="form-label">Traits (comma separated)</label>
                  <input type="text" class="form-control" id="traits" placeholder="Sweet, Caring, Playful">
                </div>
                <div class="col-md-6">
                  <label for="interests" class="form-label">Interests (comma separated)</label>
                  <input type="text" class="form-control" id="interests" placeholder="Music, Art, Travel">
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="accentColor" class="form-label">Accent Color</label>
                  <input type="color" class="form-control form-control-color" id="accentColor" value="#ec4899">
                </div>
                <div class="col-md-6">
                  <label for="textColor" class="form-label">Text Color</label>
                  <input type="color" class="form-control form-control-color" id="textColor" value="#ffffff">
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="image" class="form-label">Profile Image*</label>
                  <input type="file" class="form-control" id="image" accept="image/*">
                  <div id="currentImageContainer" class="mt-2" style="display:none;">
                    <p>Current Image:</p>
                    <img id="currentImage" height="100" alt="Current profile image">
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="backgroundImage" class="form-label">Background Image</label>
                  <input type="file" class="form-control" id="backgroundImage" accept="image/*">
                  <div id="currentBgImageContainer" class="mt-2" style="display:none;">
                    <p>Current Background:</p>
                    <img id="currentBgImage" height="100" alt="Current background image">
                  </div>
                </div>
              </div>
              
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button type="submit" class="btn btn-primary" style="background-color: #ec4899; border: none;">Save Character</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Axios for API calls -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  
  <script>
    // Global Variables
    let apiKey = localStorage.getItem('leomeAdminApiKey');
    const baseUrl = '/api/admin';
    let characters = [];
    let editMode = false;
    
    // DOM Elements
    const loginForm = document.getElementById('loginForm');
    const loginContainer = document.getElementById('loginContainer');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const dashboardSection = document.getElementById('dashboardSection');
    const charactersSection = document.getElementById('charactersSection');
    const reportsSection = document.getElementById('reportsSection');
    const newCharacterSection = document.getElementById('newCharacterSection');
    const dashboardNav = document.getElementById('dashboardNav');
    const charactersNav = document.getElementById('charactersNav');
    const reportsNav = document.getElementById('reportsNav');
    const newCharacterNav = document.getElementById('newCharacterNav');
    const logoutBtn = document.getElementById('logoutBtn');
    const charactersList = document.getElementById('charactersList');
    const characterForm = document.getElementById('characterForm');
    const characterFormTitle = document.getElementById('characterFormTitle');
    const characterSearch = document.getElementById('characterSearch');
    const cancelBtn = document.getElementById('cancelBtn');
    const spinner = document.getElementById('spinner');
    const reportsList = document.getElementById('reportsList');
    const reportPagination = document.getElementById('reportPagination');
    const reportStatusFilter = document.getElementById('reportStatusFilter');
    const reportCharacterFilter = document.getElementById('reportCharacterFilter');
    const applyReportFilters = document.getElementById('applyReportFilters');
    const reportUpdateForm = document.getElementById('reportUpdateForm');
    const saveReportChanges = document.getElementById('saveReportChanges');
    
    // Reports variables
    let reports = [];
    let currentReportPage = 1;
    let totalReportPages = 1;
    let currentReportId = null;
    
    // Check if user is logged in
    document.addEventListener('DOMContentLoaded', () => {
      if (apiKey) {
        showDashboard();
        fetchDashboardStats();
      } else {
        showLogin();
      }
    });
    
    // Login Form Submit
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      showSpinner();
      
      try {
        const response = await axios.post(`${baseUrl}/login`, { username, password });
        apiKey = response.data.apiKey;
        localStorage.setItem('leomeAdminApiKey', apiKey);
        showDashboard();
        fetchDashboardStats();
      } catch (error) {
        alert('Login failed: ' + (error.response?.data?.message || error.message));
      } finally {
        hideSpinner();
      }
    });
    
    // Logout
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('leomeAdminApiKey');
      showLogin();
    });
    
    // Navigation
    dashboardNav.addEventListener('click', (e) => {
      e.preventDefault();
      setActiveNav(dashboardNav);
      showSection(dashboardSection);
      fetchDashboardStats();
    });
    
    charactersNav.addEventListener('click', (e) => {
      e.preventDefault();
      setActiveNav(charactersNav);
      showSection(charactersSection);
      fetchCharacters();
    });
    
    reportsNav.addEventListener('click', (e) => {
      e.preventDefault();
      setActiveNav(reportsNav);
      showSection(reportsSection);
      fetchReports();
      fetchReportStats();
    });
    
    newCharacterNav.addEventListener('click', (e) => {
      e.preventDefault();
      setActiveNav(newCharacterNav);
      showSection(newCharacterSection);
      resetCharacterForm();
      editMode = false;
      characterFormTitle.textContent = 'Add New Character';
    });
    
    cancelBtn.addEventListener('click', () => {
      setActiveNav(charactersNav);
      showSection(charactersSection);
    });
    
    // Character Search
    characterSearch.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      renderCharactersList(characters.filter(char => 
        char.name.toLowerCase().includes(searchTerm) || 
        char.description.toLowerCase().includes(searchTerm)
      ));
    });
    
    // Character Form Submit
    characterForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Form Data
      const formData = new FormData();
      const characterId = document.getElementById('characterId').value;
      
      // Character fields
      const name = document.getElementById('name').value;
      const description = document.getElementById('description').value;
      const personality = document.getElementById('personality').value;
      
      // Debug the required values
      console.log('Required fields:', { name, description, personality });
      
      formData.append('name', name);
      formData.append('description', description);
      formData.append('personality', personality);
      formData.append('age', document.getElementById('age').value);
      formData.append('location', document.getElementById('location').value);
      formData.append('responseTime', document.getElementById('responseTime').value);
      formData.append('accentColor', document.getElementById('accentColor').value);
      formData.append('textColor', document.getElementById('textColor').value);
      
      // Process arrays
      const traits = document.getElementById('traits').value
        .split(',')
        .map(t => t.trim())
        .filter(t => t);
      
      const interests = document.getElementById('interests').value
        .split(',')
        .map(i => i.trim())
        .filter(i => i);
      
      formData.append('traits', JSON.stringify(traits));
      formData.append('interests', JSON.stringify(interests));
      
      // Get image files
      const imageFile = document.getElementById('image').files[0];
      const bgImageFile = document.getElementById('backgroundImage').files[0];
      
      // Debug the image file
      console.log('Image file:', imageFile);
      
      // Add image files if provided
      if (imageFile) {
        formData.append('image', imageFile);
      } else {
        console.error('No image file selected!');
        alert('Please select a profile image. It is required.');
        return;
      }
      
      if (bgImageFile) {
        formData.append('backgroundImage', bgImageFile);
      }
      
      // Debug the FormData contents
      console.log('FormData entries:');
      for (let pair of formData.entries()) {
        console.log(pair[0] + ': ' + pair[1]);
      }
      
      showSpinner();
      
      try {
        if (editMode && characterId) {
          // Update existing character
          const response = await axios.put(`${baseUrl}/characters/${characterId}?apiKey=${apiKey}`, formData, {
            headers: { 'Content-Type': 'multipart/form-data' }
          });
          console.log('Update response:', response.data);
          alert('Character updated successfully!');
        } else {
          // Create new character
          const response = await axios.post(`${baseUrl}/characters?apiKey=${apiKey}`, formData, {
            headers: { 'Content-Type': 'multipart/form-data' }
          });
          console.log('Create response:', response.data);
          alert('Character created successfully!');
        }
        
        // Go back to characters list
        setActiveNav(charactersNav);
        showSection(charactersSection);
        fetchCharacters();
      } catch (error) {
        alert('Error saving character: ' + (error.response?.data?.message || error.message));
      } finally {
        hideSpinner();
      }
    });
    
    // Fetch Dashboard Stats
    async function fetchDashboardStats() {
      showSpinner();
      
      try {
        const response = await axios.get(`${baseUrl}/stats?apiKey=${apiKey}`);
        const stats = response.data;
        
        // Update stats elements
        document.getElementById('totalCharacters').textContent = stats.totalCharacters;
        document.getElementById('activeCharacters').textContent = stats.activeCharacters;
        document.getElementById('inactiveCharacters').textContent = stats.inactiveCharacters;
        document.getElementById('serverUptime').textContent = Math.floor(stats.serverUptime);
        document.getElementById('nodeVersion').textContent = stats.nodeVersion;
        document.getElementById('mongoConnection').textContent = stats.mongoConnection;
        document.getElementById('environment').textContent = stats.environment || 'development';
        
        // Fetch recent reports for dashboard
        fetchRecentReportsForDashboard();
      } catch (error) {
        handleApiError(error);
      } finally {
        hideSpinner();
      }
    }
    
    // Fetch recent reports for dashboard
    async function fetchRecentReportsForDashboard() {
      try {
        const dashboardRecentReports = document.getElementById('dashboardRecentReports');
        
        // Fetch 5 most recent reports
        const response = await axios.get(`/api/reports?apiKey=${apiKey}&limit=5`);
        const reports = response.data.data.reports;
        
        if (reports.length === 0) {
          dashboardRecentReports.innerHTML = '<p class="text-center">No reports found</p>';
          return;
        }
        
        dashboardRecentReports.innerHTML = '';
        
        reports.forEach(report => {
          const statusClasses = {
            pending: 'bg-warning',
            reviewing: 'bg-info',
            resolved: 'bg-success',
            dismissed: 'bg-secondary'
          };
          
          const reportItem = document.createElement('div');
          reportItem.className = 'border-bottom py-2';
          
          reportItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <span class="badge ${statusClasses[report.status] || 'bg-warning'} me-2">
                  ${report.status.charAt(0).toUpperCase() + report.status.slice(1)}
                </span>
                <strong>Report #${report._id.substring(0, 8)}...</strong>
              </div>
              <small>${new Date(report.createdAt).toLocaleDateString()}</small>
            </div>
            <p class="mb-0 small text-muted">
              Reason: ${report.reason.replace('_', ' ').charAt(0).toUpperCase() + report.reason.replace('_', ' ').slice(1)}
            </p>
          `;
          
          dashboardRecentReports.appendChild(reportItem);
        });
        
        // Add event listener to view all reports button
        document.getElementById('viewAllReportsBtn').addEventListener('click', () => {
          setActiveNav(reportsNav);
          showSection(reportsSection);
          fetchReports();
          fetchReportStats();
        });
      } catch (error) {
        console.error('Error fetching recent reports:', error);
        document.getElementById('dashboardRecentReports').innerHTML = 
          '<p class="text-center text-danger">Error loading recent reports</p>';
      }
    }
    
    // Fetch Characters
    async function fetchCharacters() {
      showSpinner();
      
      try {
        const response = await axios.get(`${baseUrl}/characters?apiKey=${apiKey}`);
        characters = response.data;
        renderCharactersList(characters);
      } catch (error) {
        handleApiError(error);
      } finally {
        hideSpinner();
      }
    }
    
    // Fetch Character by ID for editing
    async function fetchCharacterById(id) {
      showSpinner();
      
      try {
        const response = await axios.get(`${baseUrl}/characters/${id}?apiKey=${apiKey}`);
        const character = response.data;
        
        // Populate form with character data
        document.getElementById('characterId').value = character.id;
        document.getElementById('name').value = character.name;
        document.getElementById('description').value = character.description;
        document.getElementById('personality').value = character.personality;
        document.getElementById('age').value = character.age || '';
        document.getElementById('location').value = character.location || '';
        document.getElementById('responseTime').value = character.responseTime || '';
        document.getElementById('accentColor').value = character.accentColor || '#ec4899';
        document.getElementById('textColor').value = character.textColor || '#ffffff';
        document.getElementById('traits').value = (character.traits || []).join(', ');
        document.getElementById('interests').value = (character.interests || []).join(', ');
        
        // Display current images
        if (character.imageUrl) {
          document.getElementById('currentImage').src = character.imageUrl;
          document.getElementById('currentImageContainer').style.display = 'block';
        }
        
        if (character.backgroundImageUrl) {
          document.getElementById('currentBgImage').src = character.backgroundImageUrl;
          document.getElementById('currentBgImageContainer').style.display = 'block';
        }
        
        // Switch to edit view
        setActiveNav(newCharacterNav);
        showSection(newCharacterSection);
        editMode = true;
        characterFormTitle.textContent = `Edit Character: ${character.name}`;
      } catch (error) {
        handleApiError(error);
      } finally {
        hideSpinner();
      }
    }
    
    // Delete Character
    async function deleteCharacter(id) {
      if (!confirm('Are you sure you want to delete this character?')) {
        return;
      }
      
      showSpinner();
      
      try {
        await axios.delete(`${baseUrl}/characters/${id}?apiKey=${apiKey}`);
        alert('Character deleted successfully!');
        fetchCharacters();
      } catch (error) {
        handleApiError(error);
      } finally {
        hideSpinner();
      }
    }
    
    // Render Characters List
    function renderCharactersList(charactersArray) {
      charactersList.innerHTML = '';
      
      if (charactersArray.length === 0) {
        charactersList.innerHTML = '<p class="text-center">No characters found</p>';
        return;
      }
      
      charactersArray.forEach(character => {
        const card = document.createElement('div');
        card.className = 'character-card p-3';
        
        card.innerHTML = `
          <div class="d-flex justify-content-between">
            <div class="d-flex">
              <img src="${character.imageUrl}" class="character-img me-3" alt="${character.name}">
              <div>
                <h5>${character.name}
                  <span class="badge ${character.isActive ? 'active-badge' : 'inactive-badge'} ms-2">
                    ${character.isActive ? 'Active' : 'Inactive'}
                  </span>
                </h5>
                <p class="text-muted small mb-1">${character.description.substring(0, 100)}...</p>
                <p class="mb-1">
                  <small>ID: ${character.id}</small>
                </p>
                <div>
                  <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${character.id}">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${character.id}">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              </div>
            </div>
            <div>
              <small class="text-muted">Created: ${new Date(character.createdAt).toLocaleDateString()}</small>
            </div>
          </div>
        `;
        
        charactersList.appendChild(card);
        
        // Add event listeners to buttons
        card.querySelector('.edit-btn').addEventListener('click', () => {
          fetchCharacterById(character.id);
        });
        
        card.querySelector('.delete-btn').addEventListener('click', () => {
          deleteCharacter(character.id);
        });
      });
    }
    
    // Reset Character Form
    function resetCharacterForm() {
      characterForm.reset();
      document.getElementById('characterId').value = '';
      document.getElementById('currentImageContainer').style.display = 'none';
      document.getElementById('currentBgImageContainer').style.display = 'none';
    }
    
    // Helper Functions
    function showLogin() {
      loginContainer.style.display = 'block';
      dashboardContainer.style.display = 'none';
    }
    
    function showDashboard() {
      loginContainer.style.display = 'none';
      dashboardContainer.style.display = 'block';
      showSection(dashboardSection);
      setActiveNav(dashboardNav);
    }
    
    function showSection(section) {
      dashboardSection.style.display = 'none';
      charactersSection.style.display = 'none';
      reportsSection.style.display = 'none';
      newCharacterSection.style.display = 'none';
      
      section.style.display = 'block';
    }
    
    function setActiveNav(navItem) {
      dashboardNav.classList.remove('active');
      charactersNav.classList.remove('active');
      reportsNav.classList.remove('active');
      newCharacterNav.classList.remove('active');
      
      navItem.classList.add('active');
    }
    
    function showSpinner() {
      spinner.style.display = 'flex';
    }
    
    function hideSpinner() {
      spinner.style.display = 'none';
    }
    
    function handleApiError(error) {
      console.error('API Error:', error);
      
      if (error.response?.status === 401) {
        localStorage.removeItem('leomeAdminApiKey');
        showLogin();
        alert('Your session has expired. Please log in again.');
      } else {
        alert('Error: ' + (error.response?.data?.message || error.message));
      }
    }
    
    // Report-related functions
    
    // Fetch Reports with Pagination and Filters
    async function fetchReports(page = 1, filters = {}) {
      showSpinner();
      currentReportPage = page;
      
      try {
        let url = `/api/reports?apiKey=${apiKey}&page=${page}&limit=10`;
        
        if (filters.status) url += `&status=${filters.status}`;
        if (filters.characterId) url += `&characterId=${filters.characterId}`;
        
        const response = await axios.get(url);
        reports = response.data.data.reports;
        totalReportPages = response.data.data.pagination.pages;
        
        renderReportsList(reports);
        renderReportPagination();
        
        // Populate character filter if not already done
        if (reportCharacterFilter.children.length <= 1) {
          populateReportCharacterFilter();
        }
      } catch (error) {
        handleApiError(error);
      } finally {
        hideSpinner();
      }
    }
    
    // Fetch Report Statistics
    async function fetchReportStats() {
      try {
        const response = await axios.get(`/api/reports/stats?apiKey=${apiKey}`);
        const stats = response.data.data;
        
        document.getElementById('totalReports').textContent = stats.totalReports || 0;
        document.getElementById('pendingReports').textContent = stats.statusStats?.pending || 0;
        document.getElementById('resolvedReports').textContent = stats.statusStats?.resolved || 0;
        document.getElementById('dismissedReports').textContent = stats.statusStats?.dismissed || 0;
      } catch (error) {
        console.error('Error fetching report stats:', error);
      }
    }
    
    // Populate Character Filter Dropdown
    async function populateReportCharacterFilter() {
      try {
        const response = await axios.get(`${baseUrl}/characters?apiKey=${apiKey}`);
        const characters = response.data;
        
        // Clear existing options except the first one
        while (reportCharacterFilter.children.length > 1) {
          reportCharacterFilter.removeChild(reportCharacterFilter.lastChild);
        }
        
        // Add options for each character
        characters.forEach(character => {
          const option = document.createElement('option');
          option.value = character.id;
          option.textContent = character.name;
          reportCharacterFilter.appendChild(option);
        });
      } catch (error) {
        console.error('Error populating character filter:', error);
      }
    }
    
    // Render Reports List
    function renderReportsList(reportsArray) {
      reportsList.innerHTML = '';
      
      if (reportsArray.length === 0) {
        reportsList.innerHTML = '<p class="text-center">No reports found</p>';
        return;
      }
      
      reportsArray.forEach(report => {
        const statusClasses = {
          pending: 'bg-warning',
          reviewing: 'bg-info',
          resolved: 'bg-success',
          dismissed: 'bg-secondary'
        };
        
        const card = document.createElement('div');
        card.className = 'card mb-3';
        
        card.innerHTML = `
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              Report #${report._id.substring(0, 8)}...
              <span class="badge ${statusClasses[report.status] || 'bg-warning'} ms-2">
                ${report.status.charAt(0).toUpperCase() + report.status.slice(1)}
              </span>
            </div>
            <small>${new Date(report.createdAt).toLocaleString()}</small>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <p><strong>Reason:</strong> ${report.reason.replace('_', ' ').charAt(0).toUpperCase() + report.reason.replace('_', ' ').slice(1)}</p>
                <p><strong>Message:</strong> ${report.messageContent.substring(0, 100)}${report.messageContent.length > 100 ? '...' : ''}</p>
              </div>
              <div class="col-md-4 text-end">
                <button class="btn btn-primary view-report-btn" data-id="${report._id}" style="background-color: #ec4899; border: none;">
                  View Details
                </button>
              </div>
            </div>
          </div>
        `;
        
        reportsList.appendChild(card);
        
        // Add event listener to view button
        card.querySelector('.view-report-btn').addEventListener('click', () => {
          viewReportDetails(report._id);
        });
      });
    }
    
    // Render Pagination for Reports
    function renderReportPagination() {
      reportPagination.innerHTML = '';
      
      if (totalReportPages <= 1) return;
      
      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentReportPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
      </a>`;
      reportPagination.appendChild(prevLi);
      
      if (currentReportPage > 1) {
        prevLi.addEventListener('click', (e) => {
          e.preventDefault();
          fetchReports(currentReportPage - 1, getReportFilters());
        });
      }
      
      // Page numbers
      for (let i = 1; i <= totalReportPages; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${currentReportPage === i ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        reportPagination.appendChild(pageLi);
        
        pageLi.addEventListener('click', (e) => {
          e.preventDefault();
          fetchReports(i, getReportFilters());
        });
      }
      
      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentReportPage === totalReportPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
      </a>`;
      reportPagination.appendChild(nextLi);
      
      if (currentReportPage < totalReportPages) {
        nextLi.addEventListener('click', (e) => {
          e.preventDefault();
          fetchReports(currentReportPage + 1, getReportFilters());
        });
      }
    }
    
    // Get Current Filter Values
    function getReportFilters() {
      return {
        status: reportStatusFilter.value,
        characterId: reportCharacterFilter.value
      };
    }
    
    // Apply Report Filters
    applyReportFilters.addEventListener('click', () => {
      fetchReports(1, getReportFilters());
    });
    
    // View Report Details
    async function viewReportDetails(reportId) {
      showSpinner();
      currentReportId = reportId;
      
      try {
        const response = await axios.get(`/api/reports/${reportId}?apiKey=${apiKey}`);
        const report = response.data.data;
        
        // Get character name if available
        let characterName = "Unknown Character";
        try {
          const charResponse = await axios.get(`${baseUrl}/characters/${report.characterId}?apiKey=${apiKey}`);
          characterName = charResponse.data.name;
        } catch (error) {
          console.warn('Could not fetch character details:', error);
        }
        
        // Fill in modal with report details
        document.getElementById('modalReportId').textContent = report._id;
        document.getElementById('modalCharacterName').textContent = characterName;
        document.getElementById('modalReportStatus').textContent = report.status.charAt(0).toUpperCase() + report.status.slice(1);
        document.getElementById('modalReportStatus').className = `badge ${getStatusBadgeClass(report.status)}`;
        document.getElementById('modalReportReason').textContent = report.reason.replace('_', ' ').charAt(0).toUpperCase() + report.reason.replace('_', ' ').slice(1);
        document.getElementById('modalReporterId').textContent = report.reporterId;
        document.getElementById('modalReportDate').textContent = new Date(report.createdAt).toLocaleString();
        document.getElementById('modalAppVersion').textContent = report.metadata?.appVersion || 'Unknown';
        document.getElementById('modalMessageContent').textContent = report.messageContent;
        
        // Handle additional details
        if (report.details) {
          document.getElementById('modalAdditionalDetails').textContent = report.details;
          document.getElementById('additionalDetailsCard').style.display = 'block';
        } else {
          document.getElementById('additionalDetailsCard').style.display = 'none';
        }
        
        // Set current status in select
        document.getElementById('updateReportStatus').value = report.status;
        
        // Set notes if available
        document.getElementById('updateReportNotes').value = report.adminReview?.notes || '';
        
        // Show modal
        const reportModal = new bootstrap.Modal(document.getElementById('reportDetailsModal'));
        reportModal.show();
      } catch (error) {
        handleApiError(error);
      } finally {
        hideSpinner();
      }
    }
    
    // Get Badge Class for Status
    function getStatusBadgeClass(status) {
      const statusClasses = {
        pending: 'bg-warning',
        reviewing: 'bg-info',
        resolved: 'bg-success',
        dismissed: 'bg-secondary'
      };
      return statusClasses[status] || 'bg-warning';
    }
    
    // Update Report Status
    saveReportChanges.addEventListener('click', async () => {
      if (!currentReportId) return;
      
      const status = document.getElementById('updateReportStatus').value;
      const notes = document.getElementById('updateReportNotes').value;
      
      showSpinner();
      
      try {
        await axios.put(`/api/reports/${currentReportId}/status?apiKey=${apiKey}`, {
          status,
          notes,
          resolution: status
        });
        
        // Close modal and refresh reports
        const reportModal = bootstrap.Modal.getInstance(document.getElementById('reportDetailsModal'));
        reportModal.hide();
        
        // Refresh reports
        fetchReports(currentReportPage, getReportFilters());
        fetchReportStats();
        
        alert('Report updated successfully!');
      } catch (error) {
        handleApiError(error);
      } finally {
        hideSpinner();
      }
    });
  </script>
</body>
</html> 